<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Loan Request Submission</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

      <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- ✅ Include in your HTML <head> or before closing </body> -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

      

    <style>
      .container-split {
        display: flex;
        height: 100vh;
      }
.table-bordered th {
  background-color: #0d6efd !important;
  color: white !important;
  vertical-align: middle;
}

      .left-container {
        width: 30%;
        padding: 20px;
        border-right: 2px solid #ddd;
      }
      .right-container {
        width: 70%;
        padding-left: 20px;
        padding-right: 20px;
        padding-bottom: 20px;
        overflow-y: auto;
      }

.preview-img {
  border: 2px solid #ccc;
  border-radius: 8px;
  padding: 5px;
  max-width: 90%;
  box-shadow: 2px 2px 6px rgba(0, 0, 0, 0.1);
  display: block;
  margin-left: auto;
  margin-right: auto;
}



      .right-container::before {
        content: "";
        position: sticky;
        top: 0;
        height: 10px;
        background: white;
        z-index: 998;
        display: block;
      }

      .loading {
        display: none;
        text-align: center;
        font-size: 24px;
      }
      .result {
        display: none;
        text-align: center;
      }
      .preview-heading {
        text-align: center;
        font-weight: bold;
        margin: 20px 0;
      }
      .preview-heading1 {
        text-align: left;
        font-weight: bold;
        margin: 20px 0;
      }
      .pdf-preview {
        width: 100%;
        border: 2px solid #ccc;
        border-radius: 5px;
        padding: 5px;
      }

      .data-table {
        width: 75%;
        margin: 20px auto;
      }
      .edit-btn {
        float: right;
        margin-bottom: 10px;
        margin-left: 20px;
      }

      .bg-green > td {
  background-color: #b4e1c3 !important; /* deeper mint green */
}

.bg-yellow > td {
  background-color: #f4d27a !important; /* stronger amber yellow */
}

.bg-red > td {
  background-color: #f1a5a5 !important; /* richer rose red */
}


      .tab-container {
        display: flex;
        position: sticky;
        top: 0;
        background-color: white;
        z-index: 999;
        gap: 10px;
        padding: 10px;
      }
      .tab-button {
        padding: 8px 16px;
        border-radius: 8px;
        background-color: lightgray;
        cursor: pointer;
        font-weight: bold;
        border: 1px solid #ccc;
        color: black;
        transition: all 0.2s ease-in-out;
      }
      .tab-button.active {
        background-color: #0d6efd;
        color: white;
      }
      .tab-content {
        display: none;
      }
      .tab-content.active {
        display: block;
      }
    </style>
  </head>
  <body>
    <div class="container-split">
      <div class="left-container">

<div class="tab-container" style="gap: 6px;">
  <button class="tab-button active" id="tabNew" onclick="switchLeftTab('newRequest')">New Loan Request</button>
  <button class="tab-button" id="tabAll" onclick="switchLeftTab('allRequests')">All Requests</button>
</div>

        <br />
        <br />
<div id="newRequest" style="display: block;">
        <h3 class="preview-heading1">New Loan Request</h3>

        <form id="loanForm">
<div class="mb-3">
  <label for="requestId" class="form-label">Request ID</label>
  <input type="text" class="form-control" id="requestId" placeholder="Enter Request ID">
</div>
          <div class="mb-3">
            <br />
            <label class="form-label">Submit Statement of Profit & Loss</label>
            <input
              type="file"
              class="form-control"
              id="profitLoss"
              accept="*/*"
              required
            />
          </div>
          <br />
          <div class="mb-3">
            <label class="form-label"
              >Submit Statement of Financial Position</label
            >
            <input
              type="file"
              class="form-control"
              id="financialPosition"
              accept="*/*"
              required
            />
          </div>
          <br />
          <button type="submit" class="btn btn-success">Submit</button>
        </form>
<div id="uploadError" style="color: red; display: none; margin-top: 10px;"></div>
</div>

<div id="allRequests" style="display: none; margin-top: 20px;">
  <h4>All Loan Requests</h4>
  <table class="table table-bordered text-center" id="allRequestsTable">
    <thead>
      <tr>
        <th>Request ID</th>
        <th>Business</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody>
      <tr><td>1</td><td>Etisalat</td><td>Approved</td></tr>
      <tr><td>2</td><td>DEWA</td><td>Approved</td></tr>
      <tr><td>3</td><td>ADNOC</td><td>Approved</td></tr>
      <tr><td>4</td><td>Shams Building and Construction</td><td>Rejected</td></tr>
    </tbody>
  </table>
</div>


      </div>

      <div class="right-container">
        <div class="tab-container" id="tabSwitcher" style="display: none">
          <div
            class="tab-button active"
            onclick="switchTab('tab-results', this)"
          >
            Results
          </div>
          <div class="tab-button" onclick="switchTab('tab-audit', this)">
            Audit History
          </div>
          <div class="tab-button" onclick="switchTab('tab-chatbot', this)">
            Ask SAS Chatbot
          </div>
        </div>

        <!-- Your current result content stays as-is below this -->

        <div class="loading" id="loading">
          <p>Processing...</p>
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
        </div>

        <div class="result" id="result">

        

          <div id="tab-results" class="tab-content active">
            <br />
            <br />

<div class="container mt-4">
  <div class="row">
    <!-- Company Information -->
    <div class="col-md-6">
      <h5><strong>Company Information</strong></h5>
      <table class="table table-bordered">
        <tbody>
          <tr><th>Business Name</th><td>RAK Ceramics P.J.S.C.</td></tr>
          <tr><th>Type of Business</th><td>Public Joint Stock Company (P.J.S.C.)</td></tr>
          <tr><th>Sector/Industry</th><td>Manufacturing – Ceramics & Sanitaryware</td></tr>
          <tr><th>Business Age</th><td>36 years (Established in 1989)</td></tr>
          <tr><th>Registered Address</th>
            <td>P.O. Box 4714, Al Jazeera Al Hamra,<br>Ras Al Khaimah, United Arab Emirates</td></tr>
        </tbody>
      </table>
    </div>

    <!-- Loan Request Details -->
    <div class="col-md-6">
      <h5><strong>Loan Request Details</strong></h5>
      <table class="table table-bordered">
        <tbody>
          <tr><th>Loan Purpose</th><td>Expansion of production capacity to meet increasing global demand</td></tr>
          <tr><th>Requested Loan Amount</th><td>AED 150,000</td></tr>
          <tr><th>Tenure</th><td>7 years</td></tr>
          <tr><th>Proposed Repayment Schedule</th><td>Quarterly installments</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>


            <h3 class="preview-heading">Preview: Statement of Profit & Loss</h3>
            <div class="text-center">
  <img id="incomePreviewImage" src="" class="img-fluid my-2 preview-img" style="display: none;" />
</div>

            <br />
            <br /><br />
            <br />

            <h3 class="preview-heading">
              Preview: Statement of Financial Position
            <div class="text-center">
  <img id="balancePreviewImage" src="" class="img-fluid my-2 preview-img" style="display: none;" />
</div>

            <br />
            <br /><br />
            <br />

            <h3 class="preview-heading">
              Extracted Financial Information: Statement of Profit & Loss
            </h3>
            <button
              class="btn btn-warning edit-btn"
              onclick="toggleEdit('financialTable1')"
            >
              Edit
            </button>
            <button
              class="btn btn-success edit-btn"
              onclick="saveTable('financialTable1')"
            >
              Save
            </button>

            <div
              id="noteContainer-financialTable1"
              style="display: none; margin-bottom: 10px"
            >
              <input
                type="text"
                id="noteInput-financialTable1"
                class="form-control"
                placeholder="Enter note for audit log"
              />
            </div>

	<!-- Nike Profit & Loss Table -->
<div id="nikePL" style="display: none;">
  <table class="table table-bordered text-center">
    <thead>
      <tr>
        <th>Description</th>
        <th>2024 (AED’000)</th>
        <th>2023 (AED’000)</th>
        <th>2022 (AED’000)</th>
      </tr>
    </thead>
    <tbody>
      <tr><td>Revenues</td><td>51,362</td><td>51,217</td><td>46,710</td></tr>
      <tr><td>Cost of sales</td><td>-28,475</td><td>-28,925</td><td>-25,231</td></tr>
      <tr><td>Gross profit</td><td>22,887</td><td>22,292</td><td>21,479</td></tr>
      <tr><td>Demand creation expense</td><td>-4,285</td><td>-4,060</td><td>-3,850</td></tr>
      <tr><td>Operating overhead expense</td><td>-12,291</td><td>-12,317</td><td>-10,954</td></tr>
      <tr><td>Total selling and administrative expense</td><td>-16,576</td><td>-16,377</td><td>-14,804</td></tr>
      <tr><td>Interest expense (income), net</td><td>161</td><td>6</td><td>-205</td></tr>
      <tr><td>Other (income) expense, net</td><td>-228</td><td>-280</td><td>-181</td></tr>
      <tr><td>Income before income taxes</td><td>6,700</td><td>6,201</td><td>6,651</td></tr>
      <tr><td>Income tax expense</td><td>-1,000</td><td>-1,131</td><td>-605</td></tr>
      <tr><td>Net income</td><td>5,700</td><td>5,070</td><td>6,046</td></tr>
      <tr><td>Earnings per common share (Basic)</td><td>3.76</td><td>3.27</td><td>3.83</td></tr>
      <tr><td>Earnings per common share (Diluted)</td><td>3.73</td><td>3.23</td><td>3.75</td></tr>
      <tr><td>Weighted average common shares outstanding (Basic)</td><td>1,517.6</td><td>1,551.6</td><td>1,578.8</td></tr>
      <tr><td>Weighted average common shares outstanding (Diluted)</td><td>1,529.7</td><td>1,569.8</td><td>1,610.8</td></tr>
    </tbody>
  </table>
</div>


            <table
              id="financialTable1"
              border="1"
              class="dataframe table table-bordered text-center data-table"
            >
              <thead>
                <tr style="text-align: right">
                  <th>Description</th>
                  <th>Six Months Ended June 30, 2024 (AED’000)</th>
                  <th>Six Months Ended June 30, 2023 (AED’000)</th>
                  <th>Three Months Ended June 30, 2024 (AED’000)</th>
                  <th>Three Months Ended June 30, 2023 (AED’000)</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td contenteditable="false">Revenue</td>
                  <td contenteditable="false">1,558,650</td>
                  <td contenteditable="false">1,754,361</td>
                  <td contenteditable="false">777,024</td>
                  <td contenteditable="false">871,983</td>
                </tr>
                <tr>
                  <td contenteditable="false">Cost of sales</td>
                  <td contenteditable="false">-943,844</td>
                  <td contenteditable="false">-1,078,181</td>
                  <td contenteditable="false">-469,680</td>
                  <td contenteditable="false">-536,951</td>
                </tr>
                <tr>
                  <td contenteditable="false">Gross profit</td>
                  <td contenteditable="false">614,806</td>
                  <td contenteditable="false">676,180</td>
                  <td contenteditable="false">307,344</td>
                  <td contenteditable="false">335,032</td>
                </tr>
                <tr>
                  <td contenteditable="false">
                    Administrative and general expenses
                  </td>
                  <td contenteditable="false">-117,228</td>
                  <td contenteditable="false">-118,987</td>
                  <td contenteditable="false">-59,490</td>
                  <td contenteditable="false">-61,191</td>
                </tr>
                <tr>
                  <td contenteditable="false">
                    Selling and distribution expenses
                  </td>
                  <td contenteditable="false">-328,461</td>
                  <td contenteditable="false">-362,023</td>
                  <td contenteditable="false">-167,931</td>
                  <td contenteditable="false">-181,631</td>
                </tr>
                <tr>
                  <td contenteditable="false">Other income</td>
                  <td contenteditable="false">36,753</td>
                  <td contenteditable="false">36,166</td>
                  <td contenteditable="false">17,403</td>
                  <td contenteditable="false">21,127</td>
                </tr>
                <tr>
                  <td contenteditable="false">Finance costs</td>
                  <td contenteditable="false">-66,873</td>
                  <td contenteditable="false">-60,374</td>
                  <td contenteditable="false">-31,233</td>
                  <td contenteditable="false">-32,478</td>
                </tr>
                <tr>
                  <td contenteditable="false">Finance income</td>
                  <td contenteditable="false">9,059</td>
                  <td contenteditable="false">7,474</td>
                  <td contenteditable="false">1,979</td>
                  <td contenteditable="false">5,886</td>
                </tr>
                <tr>
                  <td contenteditable="false">Loss on net monetary position</td>
                  <td contenteditable="false">-1,841</td>
                  <td contenteditable="false">-571</td>
                  <td contenteditable="false">-946</td>
                  <td contenteditable="false">119</td>
                </tr>
                <tr>
                  <td contenteditable="false">
                    Share of (loss)/profit in equity accounted investees
                  </td>
                  <td contenteditable="false">-125</td>
                  <td contenteditable="false">443</td>
                  <td contenteditable="false">-155</td>
                  <td contenteditable="false">421</td>
                </tr>
                <tr>
                  <td contenteditable="false">Impairment loss</td>
                  <td contenteditable="false">-12,364</td>
                  <td contenteditable="false">-13,126</td>
                  <td contenteditable="false">-7,178</td>
                  <td contenteditable="false">-7,202</td>
                </tr>
                <tr>
                  <td contenteditable="false">Profit before tax</td>
                  <td contenteditable="false">133,726</td>
                  <td contenteditable="false">165,182</td>
                  <td contenteditable="false">59,793</td>
                  <td contenteditable="false">80,083</td>
                </tr>
                <tr>
                  <td contenteditable="false">Tax expense</td>
                  <td contenteditable="false">-19,808</td>
                  <td contenteditable="false">-9,991</td>
                  <td contenteditable="false">-8,775</td>
                  <td contenteditable="false">-4,993</td>
                </tr>
                <tr>
                  <td contenteditable="false">Profit for the period</td>
                  <td contenteditable="false">113,918</td>
                  <td contenteditable="false">155,191</td>
                  <td contenteditable="false">51,018</td>
                  <td contenteditable="false">75,090</td>
                </tr>
                <tr>
                  <td contenteditable="false">
                    Profit attributable to Owners of the Company
                  </td>
                  <td contenteditable="false">107,883</td>
                  <td contenteditable="false">143,012</td>
                  <td contenteditable="false">50,274</td>
                  <td contenteditable="false">69,600</td>
                </tr>
                <tr>
                  <td contenteditable="false">
                    Profit attributable to Non-controlling interests
                  </td>
                  <td contenteditable="false">6,035</td>
                  <td contenteditable="false">12,179</td>
                  <td contenteditable="false">744</td>
                  <td contenteditable="false">5,490</td>
                </tr>
                <tr>
                  <td contenteditable="false">
                    Earnings per share - basic and diluted (AED)
                  </td>
                  <td contenteditable="false">0.11</td>
                  <td contenteditable="false">0.14</td>
                  <td contenteditable="false">0.05</td>
                  <td contenteditable="false">0.07</td>
                </tr>
              </tbody>
            </table>

            <br />
            <br />
            <br />
            <br />

            <h3 class="preview-heading">
              Extracted Financial Information: Statement of Financial Position
            </h3>
            <button
              class="btn btn-warning edit-btn"
              onclick="toggleEdit('financialTable2')"
            >
              Edit
            </button>
            <button
              class="btn btn-success edit-btn"
              onclick="saveTable('financialTable2')"
            >
              Save
            </button>
            <div
              id="noteContainer-financialTable2"
              style="display: none; margin-bottom: 10px"
            >
              <input
                type="text"
                id="noteInput-financialTable2"
                class="form-control"
                placeholder="Enter note for audit log"
              />
            </div>

<div id="nikeBS" style="display: none;">
  <table class="table table-bordered text-center">
    <thead>
      <tr>
        <th>Description</th>
        <th>2024 (AED’000)</th>
        <th>2023 (AED’000)</th>
      </tr>
    </thead>
    <tbody>
      <tr><td><strong>ASSETS</strong></td><td></td><td></td></tr>
      <tr><td><strong>Current assets:</strong></td><td></td><td></td></tr>
      <tr><td>Cash and equivalents</td><td>9,860</td><td>7,441</td></tr>
      <tr><td>Short-term investments</td><td>1,722</td><td>3,234</td></tr>
      <tr><td>Accounts receivable, net</td><td>4,427</td><td>4,131</td></tr>
      <tr><td>Inventories</td><td>7,519</td><td>8,454</td></tr>
      <tr><td>Prepaid expenses and other current assets</td><td>1,854</td><td>1,942</td></tr>
      <tr><td>Total current assets</td><td>25,382</td><td>25,202</td></tr>
      <tr><td>Property, plant and equipment, net</td><td>5,000</td><td>5,081</td></tr>
      <tr><td>Operating lease right-of-use assets, net</td><td>2,718</td><td>2,923</td></tr>
      <tr><td>Identifiable intangible assets, net</td><td>259</td><td>274</td></tr>
      <tr><td>Goodwill</td><td>240</td><td>281</td></tr>
      <tr><td>Deferred income taxes and other assets</td><td>4,511</td><td>3,770</td></tr>
      <tr><td><strong>TOTAL ASSETS</strong></td><td>38,110</td><td>37,531</td></tr>
      <tr><td><strong>LIABILITIES AND SHAREHOLDERS' EQUITY</strong></td><td></td><td></td></tr>
      <tr><td><strong>Current liabilities:</strong></td><td></td><td></td></tr>
      <tr><td>Current portion of long-term debt</td><td>1,000</td><td></td></tr>
      <tr><td>Notes payable</td><td>6</td><td>6</td></tr>
      <tr><td>Accounts payable</td><td>2,851</td><td>2,862</td></tr>
      <tr><td>Current portion of operating lease liabilities</td><td>477</td><td>425</td></tr>
      <tr><td>Accrued liabilities</td><td>5,725</td><td>5,723</td></tr>
      <tr><td>Income taxes payable</td><td>534</td><td>240</td></tr>
      <tr><td>Total current liabilities</td><td>10,593</td><td>9,256</td></tr>
      <tr><td>Long-term debt</td><td>7,903</td><td>8,927</td></tr>
      <tr><td>Operating lease liabilities</td><td>2,566</td><td>2,786</td></tr>
      <tr><td>Deferred income taxes and other liabilities</td><td>2,618</td><td>2,558</td></tr>
      <tr><td>Commitments and contingencies (Note 16)</td><td></td><td></td></tr>
      <tr><td>Redeemable preferred stock</td><td></td><td></td></tr>
      <tr><td><strong>Shareholders' equity:</strong></td><td></td><td></td></tr>
      <tr><td>Common stock at stated value:</td><td></td><td></td></tr>
      <tr><td>Class A convertible — 298 and 305 shares outstanding</td><td></td><td></td></tr>
      <tr><td>Class B — 1,205 and 1,227 shares outstanding</td><td>3</td><td>3</td></tr>
      <tr><td>Capital in excess of stated value</td><td>13,409</td><td>12,412</td></tr>
      <tr><td>Accumulated other comprehensive income (loss)</td><td>53</td><td>231</td></tr>
      <tr><td>Retained earnings (deficit)</td><td>965</td><td>1,358</td></tr>
      <tr><td>Total shareholders' equity</td><td>14,430</td><td>14,004</td></tr>
      <tr><td><strong>TOTAL LIABILITIES AND SHAREHOLDERS' EQUITY</strong></td><td>38,110</td><td>37,531</td></tr>
    </tbody>
  </table>
</div>


            <table
              id="financialTable2"
              border="1"
              class="dataframe table table-bordered text-center data-table"
            >
              <thead>
                <tr style="text-align: right">
                  <th>Description</th>
                  <th>30 June 2024 AED'000 (unaudited)</th>
                  <th>31 December 2023 AED'000 (audited)</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td contenteditable="false">Assets</td>
                  <td contenteditable="false"></td>
                  <td contenteditable="false"></td>
                </tr>
                <tr>
                  <td contenteditable="false">Non-current assets</td>
                  <td contenteditable="false"></td>
                  <td contenteditable="false"></td>
                </tr>
                <tr>
                  <td contenteditable="false">Property, plant and equipment</td>
                  <td contenteditable="false">1,359,201</td>
                  <td contenteditable="false">1,354,744</td>
                </tr>
                <tr>
                  <td contenteditable="false">Goodwill</td>
                  <td contenteditable="false">120,098</td>
                  <td contenteditable="false">120,135</td>
                </tr>
                <tr>
                  <td contenteditable="false">Right-of-use assets</td>
                  <td contenteditable="false">88,228</td>
                  <td contenteditable="false">87,632</td>
                </tr>
                <tr>
                  <td contenteditable="false">Intangible assets</td>
                  <td contenteditable="false">13,453</td>
                  <td contenteditable="false">14,932</td>
                </tr>
                <tr>
                  <td contenteditable="false">Investment properties</td>
                  <td contenteditable="false">896,847</td>
                  <td contenteditable="false">900,742</td>
                </tr>
                <tr>
                  <td contenteditable="false">
                    Investments in equity accounted investees
                  </td>
                  <td contenteditable="false">10,539</td>
                  <td contenteditable="false">11,332</td>
                </tr>
                <tr>
                  <td contenteditable="false">Long-term receivables</td>
                  <td contenteditable="false">17,583</td>
                  <td contenteditable="false">21,556</td>
                </tr>
                <tr>
                  <td contenteditable="false">Derivative financial assets</td>
                  <td contenteditable="false">2,937</td>
                  <td contenteditable="false">4,277</td>
                </tr>
                <tr>
                  <td contenteditable="false">Deferred tax assets</td>
                  <td contenteditable="false">5,992</td>
                  <td contenteditable="false">6,041</td>
                </tr>
                <tr>
                  <td contenteditable="false">Total non-current assets</td>
                  <td contenteditable="false">2,514,878</td>
                  <td contenteditable="false">2,521,391</td>
                </tr>
                <tr>
                  <td contenteditable="false">Current assets</td>
                  <td contenteditable="false"></td>
                  <td contenteditable="false"></td>
                </tr>
                <tr>
                  <td contenteditable="false">Inventories</td>
                  <td contenteditable="false">1,316,726</td>
                  <td contenteditable="false">1,301,903</td>
                </tr>
                <tr>
                  <td contenteditable="false">Trade and other receivables</td>
                  <td contenteditable="false">1,173,000</td>
                  <td contenteditable="false">1,189,975</td>
                </tr>
                <tr>
                  <td contenteditable="false">Due from related parties</td>
                  <td contenteditable="false">49,245</td>
                  <td contenteditable="false">55,734</td>
                </tr>
                <tr>
                  <td contenteditable="false">Derivative financial assets</td>
                  <td contenteditable="false">9,870</td>
                  <td contenteditable="false">7,462</td>
                </tr>
                <tr>
                  <td contenteditable="false">
                    Bank deposits with an original maturity of more than three
                    months
                  </td>
                  <td contenteditable="false">14,667</td>
                  <td contenteditable="false">41,381</td>
                </tr>
                <tr>
                  <td contenteditable="false">Cash and cash equivalents</td>
                  <td contenteditable="false">187,407</td>
                  <td contenteditable="false">239,245</td>
                </tr>
                <tr>
                  <td contenteditable="false">Total current assets</td>
                  <td contenteditable="false">2,750,915</td>
                  <td contenteditable="false">2,835,700</td>
                </tr>
                <tr>
                  <td contenteditable="false">Total assets</td>
                  <td contenteditable="false">5,265,793</td>
                  <td contenteditable="false">5,357,091</td>
                </tr>
                <tr>
                  <td contenteditable="false">Equity and liabilities</td>
                  <td contenteditable="false"></td>
                  <td contenteditable="false"></td>
                </tr>
                <tr>
                  <td contenteditable="false">Capital and reserves</td>
                  <td contenteditable="false"></td>
                  <td contenteditable="false"></td>
                </tr>
                <tr>
                  <td contenteditable="false">Share capital</td>
                  <td contenteditable="false">993,703</td>
                  <td contenteditable="false">993,703</td>
                </tr>
                <tr>
                  <td contenteditable="false">Reserves</td>
                  <td contenteditable="false">1,222,007</td>
                  <td contenteditable="false">1,240,552</td>
                </tr>
                <tr>
                  <td contenteditable="false">
                    Equity attributable to owners of the Company
                  </td>
                  <td contenteditable="false">2,215,710</td>
                  <td contenteditable="false">2,234,255</td>
                </tr>
                <tr>
                  <td contenteditable="false">Non-controlling interests</td>
                  <td contenteditable="false">92,594</td>
                  <td contenteditable="false">134,495</td>
                </tr>
                <tr>
                  <td contenteditable="false">Total equity</td>
                  <td contenteditable="false">2,308,304</td>
                  <td contenteditable="false">2,368,750</td>
                </tr>
                <tr>
                  <td contenteditable="false">Non-current liabilities</td>
                  <td contenteditable="false"></td>
                  <td contenteditable="false"></td>
                </tr>
                <tr>
                  <td contenteditable="false">Islamic bank financing</td>
                  <td contenteditable="false">242,523</td>
                  <td contenteditable="false">296,674</td>
                </tr>
                <tr>
                  <td contenteditable="false">
                    Interest bearing bank financing
                  </td>
                  <td contenteditable="false">664,436</td>
                  <td contenteditable="false">620,998</td>
                </tr>
                <tr>
                  <td contenteditable="false">Due to related parties</td>
                  <td contenteditable="false">2,159</td>
                  <td contenteditable="false">2,163</td>
                </tr>
                <tr>
                  <td contenteditable="false">
                    Provision for employees' end of service benefits
                  </td>
                  <td contenteditable="false">116,899</td>
                  <td contenteditable="false">118,453</td>
                </tr>
                <tr>
                  <td contenteditable="false">Lease liabilities</td>
                  <td contenteditable="false">71,529</td>
                  <td contenteditable="false">67,804</td>
                </tr>
                <tr>
                  <td contenteditable="false">Deferred tax liabilities</td>
                  <td contenteditable="false">26,709</td>
                  <td contenteditable="false">29,973</td>
                </tr>
                <tr>
                  <td contenteditable="false">Total non-current liabilities</td>
                  <td contenteditable="false">1,124,255</td>
                  <td contenteditable="false">1,136,065</td>
                </tr>
                <tr>
                  <td contenteditable="false">Current liabilities</td>
                  <td contenteditable="false"></td>
                  <td contenteditable="false"></td>
                </tr>
                <tr>
                  <td contenteditable="false">Islamic bank financing</td>
                  <td contenteditable="false">298,263</td>
                  <td contenteditable="false">317,399</td>
                </tr>
                <tr>
                  <td contenteditable="false">
                    Interest bearing bank financing
                  </td>
                  <td contenteditable="false">547,862</td>
                  <td contenteditable="false">463,765</td>
                </tr>
                <tr>
                  <td contenteditable="false">Trade and other payables</td>
                  <td contenteditable="false">767,865</td>
                  <td contenteditable="false">817,704</td>
                </tr>
                <tr>
                  <td contenteditable="false">Due to related parties</td>
                  <td contenteditable="false">16,656</td>
                  <td contenteditable="false">44,939</td>
                </tr>
                <tr>
                  <td contenteditable="false">
                    Derivative financial liabilities
                  </td>
                  <td contenteditable="false">585</td>
                  <td contenteditable="false">4,296</td>
                </tr>
                <tr>
                  <td contenteditable="false">Lease liabilities</td>
                  <td contenteditable="false">32,085</td>
                  <td contenteditable="false">32,846</td>
                </tr>
                <tr>
                  <td contenteditable="false">Provision for taxation</td>
                  <td contenteditable="false">169,918</td>
                  <td contenteditable="false">171,327</td>
                </tr>
                <tr>
                  <td contenteditable="false">Total current liabilities</td>
                  <td contenteditable="false">1,833,234</td>
                  <td contenteditable="false">1,852,276</td>
                </tr>
                <tr>
                  <td contenteditable="false">Total liabilities</td>
                  <td contenteditable="false">2,957,489</td>
                  <td contenteditable="false">2,988,341</td>
                </tr>
                <tr>
                  <td contenteditable="false">Total equity and liabilities</td>
                  <td contenteditable="false">5,265,793</td>
                  <td contenteditable="false">5,357,091</td>
                </tr>
              </tbody>
            </table>

            <br />
            <br /><br />
            <br />

            <h3 class="preview-heading">
              Financial Ratios for Loan Decisioning
            </h3>
            <table id="ratios" class="table table-bordered text-center mt-3">
              <thead>
                <tr>
                  <th>Metric</th>
                  <th>Value</th>
                  <th>Calculation</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>Short Term Liab./Total Assets</td>
                  <td>0.3482</td>
                  <td>
                    (Total Current Liabilities / Total Assets) <br />
                    (1,833,234 / 5,265,793)
                  </td>
                </tr>
                <tr>
                  <td>Net Profit Margin</td>
                  <td>0.0731</td>
                  <td>
                    (Profit for the Period / Revenue) <br />
                    (113,918 / 1,558,650)
                  </td>
                </tr>
                <tr>
                  <td>Equity / Total Liabilities (t-1)</td>
                  <td>0.7724</td>
                  <td>
                    (Total Equity / Total Liabilities) <br />
                    (2,308,304 / 2,988,341)
                  </td>
                </tr>
                <tr>
                  <td>Inventories / Current Assets</td>
                  <td>0.4787</td>
                  <td>
                    (Inventories / Total Current Assets) <br />
                    (1,316,726 / 2,750,915)
                  </td>
                </tr>
                <tr>
                  <td>Cash Ratio</td>
                  <td>0.1022</td>
                  <td>
                    (Cash and Cash Equivalents / Total Current Liabilities)
                    <br />
                    (187,407 / 1,833,234)
                  </td>
                </tr>
                <tr>
                  <td>EBIT / Net Sales</td>
                  <td>0.0858</td>
                  <td>
                    (Profit Before Tax / Revenue) <br />
                    (133,726 / 1,558,650)
                  </td>
                </tr>
              </tbody>
            </table>

            <br />

          <h3 class="preview-heading">Financial Health (2023 vs 2024)</h3>
<table id="financialHealth" class="table table-bordered text-center mt-3">
  <thead>
    <tr>
      <th>Metric</th>
      <th>2024 Value</th>
      <th>2023 Value</th>
      <th>Difference %</th>
    </tr>
  </thead>
  <tbody>
  </tbody>
</table>


<canvas id="financialHealthChart" width="800" height="400" style="margin-top: 40px;"></canvas>

<br>
<br>



            <h3 id="scoreHeading">Financial Module Score: 62 / 100</h3>
            <h3 id="riskCategoryHeading" class="text-warning">
              Risk Category: Class 3 (Moderate)
            </h3>

<br>
<br>

<div class="alert alert-info mt-3 d-flex align-items-center justify-content-between">
  <div id="decisionRuleResult">
    <strong>Authority Check:</strong> Checking...
  </div>
  <div style="position: relative;">
    <span id="scorecardIcon"
      tabindex="0"
      class="ms-2 text-primary"
      data-bs-toggle="popover"
      data-bs-html="true"
      data-bs-trigger="hover"
      data-bs-placement="right"
      data-bs-content="">
  &#9432;
</span>


  </div>
</div>


<div class="container mt-4">
  <div class="row mb-3">

      <div class="row mb-3">
  <label class="col-sm-4 col-form-label"><strong>Your Name and Role:</strong></label>
  <div class="col-sm-8">
    <input type="text" class="form-control" value="Saman Khan (  Junior Credit Underwriter )" readonly />
  </div>
</div>

    <label class="col-sm-4 col-form-label"><strong>Reason for Approval or Rejection:</strong></label>
    <div class="col-sm-8">
      <input type="text" id="justificationInput" class="form-control" placeholder="Enter justification..." />

    </div>
  </div>
  <div class="row mb-3">
    <label class="col-sm-4 col-form-label"><strong>Approved Loan Amount:</strong></label>
    <div class="col-sm-8">
      <input type="text" id="approvedAmountInput" class="form-control" value="AED 150,000" />

    </div>
  </div>
  <div class="row mb-3">
    <label class="col-sm-4 col-form-label"><strong>Additional Terms:</strong></label>
    <div class="col-sm-8">
      <input type="text" id="termsInput" class="form-control" placeholder="Optional conditions or remarks..." />

    </div>
  </div>
</div>


           <div class="mt-3" id="buttonContainer">
  <!-- Buttons will be added by JS -->
</div>

          </div>
        </div>

        <div id="tab-audit" class="tab-content" style="display: none">
          <br />
          <br />
      <h4 class="mt-5">Data Modification Log</h4>
          <table class="table table-bordered text-center mt-3">
            <thead>
              <tr>
                <th>Date Time</th>
                <th>Changed By</th>
                <th>Value</th>
                <th>Before</th>
                <th>After</th>
                <th>Notes</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>2025-04-24 13:00</td>
                <td>Admin</td>
                <td>Revenue</td>
                <td>1,200,000</td>
                <td>1,558,650</td>
                <td>Manual correction</td>
              </tr>
            </tbody>
          </table>

      
      <h4 class="mt-5">Loan Decision</h4>
<table id="loanDecisionTable" class="table table-bordered text-center mt-3">
  <thead>
    <tr>
      <th>Date Time</th>
      <th>User</th>
      <th>Status</th>
      <th>Justification</th>
      <th>Approved Amount</th>
      <th>Additional Terms</th>
    </tr>
  </thead>
  <tbody>
  </tbody>
</table>

      






        </div>

        <div id="tab-chatbot" class="tab-content" style="display: none">
          <iframe
            src="https://www.chatbase.co/chatbot-iframe/xGsCmoCAOJE7IeGEXKnya"
            width="100%"
            style="height: 90%; min-height: 550px"
            frameborder="0"
          ></iframe>
        </div>
      </div>
    </div>

    <script>
      let editHistory = {};

      function toggleEdit(tableId) {
        let table = document.getElementById(tableId);
        let cells = table.querySelectorAll("td[contenteditable]");

        // Toggle contentEditable state
        const isEditing = cells[0].contentEditable === "true";
        cells.forEach((cell) => {
          cell.contentEditable = isEditing ? "false" : "true";
        });

        // Show note input when entering edit mode
        if (!isEditing) {
          document.getElementById(`noteContainer-${tableId}`).style.display =
            "block";

          // Capture original values for audit trail
          editHistory[tableId] = [];
          const rows = table.querySelectorAll("tbody tr");

          rows.forEach((row, rowIndex) => {
            const cells = row.querySelectorAll("td");
            for (let colIndex = 1; colIndex < cells.length; colIndex++) {
              if (cells[colIndex].isContentEditable) {
                editHistory[tableId].push({
                  rowIndex,
                  colIndex,
                  value: cells[colIndex].innerText,
                });
              }
            }
          });
        } else {
          // If toggling off edit mode, hide the note input field
          document.getElementById(`noteContainer-${tableId}`).style.display =
            "none";
        }
      }
      function saveTable(tableId) {
        let table = document.getElementById(tableId);
        let cells = table.querySelectorAll("td[contenteditable]");
        let data = [];
        cells.forEach((cell) => {
          data.push(cell.innerText);
          cell.contentEditable = "false";
        });
        console.log("Saved Data:", data);
        alert("Table data saved!");

        // 🔄 Refresh ratios after saving table
        updateRatiosFromTables();

        // 🎨 Recolor the ratios table
        setTimeout(() => colorRatioRowsAccurately(), 100); // slight delay ensures DOM is ready

        updateFinancialModuleScore();

        let auditTable = document.querySelector("#tab-audit tbody");
        let rows = document.querySelectorAll(`#${tableId} tbody tr`);
        let note = document.getElementById(`noteInput-${tableId}`).value;
        let now = new Date().toISOString().slice(0, 19).replace("T", " ");

        editHistory[tableId]?.forEach((edit) => {
          let row = rows[edit.rowIndex];
          let desc = row.cells[0].innerText;
          let before = edit.value;
          let after = row.cells[edit.colIndex].innerText;

          if (before !== after) {
            let newRow = document.createElement("tr");
            newRow.innerHTML = `
      <td>${now}</td>
      <td>Saman Khan</td>
      <td>${desc}</td>
      <td>${before}</td>
      <td>${after}</td>
      <td>${note}</td>
    `;
            auditTable.appendChild(newRow);
          }
        });

        document.getElementById(`noteContainer-${tableId}`).style.display =
          "none";
        document.getElementById(`noteInput-${tableId}`).value = "";
      }

      document
        .getElementById("loanForm")
        .addEventListener("submit", function (event) {
          event.preventDefault();
	  const profitFile = document.getElementById("profitLoss").files[0];
const positionFile = document.getElementById("financialPosition").files[0];
const isNike = profitFile?.name.startsWith("Nike") || positionFile?.name.startsWith("Nike");

          console.log("Form submitted!");
          const profitLoss = document.getElementById("profitLoss").files.length;
          const financialPosition =
            document.getElementById("financialPosition").files.length;

          if (profitLoss === 0 || financialPosition === 0) {
            alert("Please upload both required PDF documents.");
            return;
          }

          console.log("Files uploaded successfully.");
          document.getElementById("loading").style.display = "block";
          document.getElementById("result").style.display = "none";

document.getElementById("incomePreviewImage").src = isNike
  ? "Nike_IncomeStatement.png"
  : "RAKCeramics_IncomeStatement.png";

document.getElementById("balancePreviewImage").src = isNike
  ? "Nike_BalanceSheet.png"
  : "RAKCeramics_BalanceSheet.png";

// Show images
document.getElementById("incomePreviewImage").style.display = "block";
document.getElementById("balancePreviewImage").style.display = "block";

          setTimeout(() => {
if (isNike) {
  document.getElementById("financialTable1").style.display = "none";
  document.getElementById("financialTable2").style.display = "none";
  document.getElementById("nikePL").style.display = "block";
  document.getElementById("nikeBS").style.display = "block";
} else {
  document.getElementById("nikePL").style.display = "none";
  document.getElementById("nikeBS").style.display = "none";
  document.getElementById("financialTable1").style.display = "table";
  document.getElementById("financialTable2").style.display = "table";
}

            console.log("Displaying results after delay.");
            document.getElementById("loading").style.display = "none";
            document.getElementById("result").style.display = "block";
            updateRatiosFromTables();
renderApprovalButtons(); // 🔸 Add this
          }, 10);
        });

      function colorRatioRowsAccurately() {
        const ratioTable = document.getElementById("ratios");
        if (!ratioTable) return;

        const rows = ratioTable.querySelectorAll("tbody tr");

        rows.forEach((row) => {
          const cells = row.querySelectorAll("td");
          const metric = cells[0]?.innerText.trim();
          const value = parseFloat(cells[1]?.innerText.trim());
          let colorClass = "";

          if (!metric || isNaN(value)) return;

          if (metric === "Short Term Liab./Total Assets") {
            if (value < 0.4) colorClass = "bg-green";
            else if (value < 0.64) colorClass = "bg-yellow";
            else colorClass = "bg-red";
          } else if (metric === "Net Profit Margin") {
            if (value > 0.1) colorClass = "bg-green";
            else if (value > 0.05) colorClass = "bg-yellow";
            else colorClass = "bg-red";
          } else if (metric === "Equity / Total Liabilities (t-1)") {
            if (value > 0.25) colorClass = "bg-green";
            else if (value > 0.05) colorClass = "bg-yellow";
            else colorClass = "bg-red";
          } else if (metric === "Inventories / Current Assets") {
            if (value > 0.15) colorClass = "bg-green";
            else if (value > 0.07) colorClass = "bg-yellow";
            else colorClass = "bg-red";
          } else if (metric === "Cash Ratio") {
            if (value > 0.15) colorClass = "bg-green";
            else colorClass = "bg-red";
          } else if (metric === "EBIT / Net Sales") {
            if (value > 0.1) colorClass = "bg-green";
            else colorClass = "bg-red";
          }

          if (colorClass) {
            row.classList.add(colorClass);
          }
        });
      }

      // Trigger when result section is visible
      const resultObserver = new MutationObserver(() => {
        const result = document.getElementById("result");
        if (result.style.display === "block") {
          // Show the tab switcher at the top
          document.getElementById("tabSwitcher").style.display = "flex";

          // Apply row coloring
          setTimeout(() => colorRatioRowsAccurately(), 200);

          // Disconnect observer
          resultObserver.disconnect();
        }
      });

      resultObserver.observe(document.getElementById("result"), {
        attributes: true,
        attributeFilter: ["style"],
      });

      function switchTab(tabId, element) {
        document.querySelectorAll(".tab-content").forEach((tab) => {
          tab.style.display = "none";
        });
        document.getElementById(tabId).style.display = "block";

        document.querySelectorAll(".tab-button").forEach((btn) => {
          btn.classList.remove("active");
        });
        element.classList.add("active");
      }

      function updateRatiosFromTables() {
  const isNike = document.getElementById("nikePL").style.display === "block";

  const getValue = (tableId, rowLabel) => {
    const tableSelector = isNike
      ? tableId === "financialTable1"
        ? "#nikePL"
        : "#nikeBS"
      : `#${tableId}`;
    const rows = document.querySelectorAll(`${tableSelector} tbody tr`);
    for (let row of rows) {
      const label = row.cells[0]?.innerText.trim().toLowerCase();
      if (label === rowLabel.toLowerCase()) {
        return parseFloat(row.cells[1]?.innerText.replace(/,/g, "")) || 0;
      }
    }
    return 0;
  };

  const ratios = [
    {
      metric: "Short Term Liab./Total Assets",
      numLabel: "Total current liabilities",
      denomLabel: "Total assets",
      tableId: "financialTable2",
      formula: "(Total current liabilities / Total assets)",
    },
    {
      metric: "Net Profit Margin",
      numLabel: isNike ? "Net income" : "Profit for the period",
      denomLabel: isNike ? "Revenues" : "Revenue",
      tableId: "financialTable1",
      formula: isNike
        ? "(Net income / Revenues)"
        : "(Profit for the period / Revenue)",
    },
    {
      metric: "Equity / Total Liabilities (t-1)",
      numLabel: isNike
        ? "Total shareholders' equity"
        : "Total equity",
      denomLabel: "Total liabilities",
      tableId: "financialTable2",
      formula: "(Equity / Total liabilities)",
    },
    {
      metric: "Inventories / Current Assets",
      numLabel: "Inventories",
      denomLabel: "Total current assets",
      tableId: "financialTable2",
      formula: "(Inventories / Total current assets)",
    },
    {
      metric: "Cash Ratio",
      numLabel: isNike ? "Cash and equivalents" : "Cash and cash equivalents",
      denomLabel: "Total current liabilities",
      tableId: "financialTable2",
      formula: "(Cash / Current liabilities)",
    },
    {
      metric: "EBIT / Net Sales",
      numLabel: isNike
        ? "Income before income taxes"
        : "Profit before tax",
      denomLabel: isNike ? "Revenues" : "Revenue",
      tableId: "financialTable1",
      formula: "(EBIT / Revenue)",
    },
  ];

  const ratioTable = document.querySelector("#ratios tbody");
  ratioTable.innerHTML = "";

  ratios.forEach((r) => {
    let numerator = getValue(r.tableId, r.numLabel);
    let denominator = getValue(r.tableId, r.denomLabel);

    // Handle Nike-specific case for Total Liabilities (not directly available)
    if (r.metric === "Equity / Total Liabilities (t-1)" && isNike) {
      const totalAssets = getValue("financialTable2", "Total assets");
      const totalEquity = getValue("financialTable2", "Total shareholders' equity");
      denominator = totalAssets - totalEquity;
    }

    const value =
      denominator !== 0 ? (numerator / denominator).toFixed(4) : "N/A";
    const calcText = `${
      r.formula
    }<br>(${numerator.toLocaleString()} / ${denominator.toLocaleString()})`;

    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${r.metric}</td>
      <td>${value}</td>
      <td>${calcText}</td>
    `;
    ratioTable.appendChild(row);
  });

  populateFinancialHealthTable();

  document.querySelectorAll("#financialHealth tbody tr").forEach((row) => {
    row.addEventListener("click", () => {
      const metric = row.cells[0].innerText.trim();
      renderFinancialHealthChart(metric);
    });
  });

updateFinancialModuleScore();

}

     function updateFinancialModuleScore() {
  const rows = document.querySelectorAll("#ratios tbody tr");
  const ratioValues = [];

  rows.forEach((row) => {
    const val = parseFloat(row.cells[1]?.innerText);
    if (!isNaN(val)) {
      ratioValues.push(val);
    }
  });

  if (ratioValues.length === 0) {
    document.getElementById("scoreValue").innerText = "N/A";
    document.getElementById("riskValue").innerText = "N/A";
    return;
  }

  // 🎯 Basic scoring logic (customize this logic if needed)
  let score = 0;
  ratioValues.forEach((v) => {
    if (v >= 0.3) score += 15;
    else if (v >= 0.15) score += 10;
    else if (v > 0) score += 5;
  });

  const maxScore = ratioValues.length * 15;
  const finalScore = Math.round((score / maxScore) * 100);

  // 🏷 Risk Category Buckets
  let category = "Class 1 (Low Risk)";
  if (finalScore < 30) category = "Class 5 (Very High Risk)";
  else if (finalScore < 50) category = "Class 4 (High Risk)";
  else if (finalScore < 70) category = "Class 3 (Moderate Risk)";
  else if (finalScore < 85) category = "Class 2 (Mild Risk)";

  document.getElementById("scoreValue").innerText = finalScore;
  document.getElementById("riskValue").innerText = category;
}





function recordLoanDecision(status) {
  const justification = document.getElementById("justificationInput").value;
  const approvedAmount = document.getElementById("approvedAmountInput").value;
  const terms = document.getElementById("termsInput").value;

  const now = new Date().toISOString().slice(0, 19).replace("T", " ");
  const table = document.querySelector("#loanDecisionTable tbody");

  const newRow = document.createElement("tr");
  newRow.innerHTML = `
    <td>${now}</td>
    <td>Saman Khan</td>
    <td>${status}</td>
    <td>${justification}</td>
    <td>${approvedAmount}</td>
    <td>${terms}</td>
  `;
  table.appendChild(newRow);

  // Also add to All Requests table
  const allTable = document.querySelector("#allRequestsTable tbody");
  const newId = allTable.rows.length + 1;
  const newReqRow = document.createElement("tr");
  newReqRow.innerHTML = `<td>${newId}</td><td>RAK Ceramics P.J.S.C.</td><td>${status}</td>`;
  allTable.appendChild(newReqRow);

  alert(`Loan decision "${status}" recorded successfully.`);
}







function validateUploadedFile(fileInput) {
  const file = fileInput.files[0];
  const errorContainer = document.getElementById("uploadError");

  if (file && file.name === "RAKCeramics_ChangesInEquity.pdf") {
    errorContainer.innerText = "Couldn't find the required data in the uploaded document. Please try again.";
    errorContainer.style.display = "block";
    fileInput.value = ""; // clear the file
  } else {
    errorContainer.innerText = "";
    errorContainer.style.display = "none";
  }
}

document.getElementById("profitLoss").addEventListener("change", function () {
  validateUploadedFile(this);
});

document.getElementById("financialPosition").addEventListener("change", function () {
  validateUploadedFile(this);
});


function switchLeftTab(tabName) {
  document.getElementById("newRequest").style.display = tabName === "newRequest" ? "block" : "none";
  document.getElementById("allRequests").style.display = tabName === "allRequests" ? "block" : "none";

  document.getElementById("tabNew").classList.toggle("active", tabName === "newRequest");
  document.getElementById("tabAll").classList.toggle("active", tabName === "allRequests");
}


function populateFinancialHealthTable() {
  const isNike = document.getElementById("nikePL").style.display === "block";

  const getValue = (tableId, rowLabel, yearCol) => {
    const tableSelector = isNike
      ? tableId === "financialTable1"
        ? "#nikePL"
        : "#nikeBS"
      : `#${tableId}`;
    const rows = document.querySelectorAll(`${tableSelector} tbody tr`);
    for (let row of rows) {
      const label = row.cells[0]?.innerText.trim().toLowerCase();
      if (label === rowLabel.toLowerCase()) {
        return parseFloat(row.cells[yearCol]?.innerText.replace(/,/g, "")) || 0;
      }
    }
    return 0;
  };

  const metrics = [
    {
      metric: "Short Term Liab./Total Assets",
      numLabel: "Total current liabilities",
      denomLabel: "Total assets",
      tableId: "financialTable2",
    },
    {
      metric: "Net Profit Margin",
      numLabel: isNike ? "Net income" : "Profit for the period",
      denomLabel: isNike ? "Revenues" : "Revenue",
      tableId: "financialTable1",
    },
    {
      metric: "Equity / Total Liabilities (t-1)",
      numLabel: isNike ? "Total shareholders' equity" : "Total equity",
      denomLabel: "Total liabilities", // computed for Nike
      tableId: "financialTable2",
    },
    {
      metric: "Inventories / Current Assets",
      numLabel: "Inventories",
      denomLabel: "Total current assets",
      tableId: "financialTable2",
    },
    {
      metric: "Cash Ratio",
      numLabel: isNike ? "Cash and equivalents" : "Cash and cash equivalents",
      denomLabel: "Total current liabilities",
      tableId: "financialTable2",
    },
    {
      metric: "EBIT / Net Sales",
      numLabel: isNike
        ? "Income before income taxes"
        : "Profit before tax",
      denomLabel: isNike ? "Revenues" : "Revenue",
      tableId: "financialTable1",
    },
  ];

  const healthTable = document.querySelector("#financialHealth tbody");
  healthTable.innerHTML = "";

  metrics.forEach((r) => {
    let val2024, val2023;

    if (r.metric === "Equity / Total Liabilities (t-1)" && isNike) {
      const equity2024 = getValue(r.tableId, r.numLabel, 1);
      const equity2023 = getValue(r.tableId, r.numLabel, 2);
      const assets2024 = getValue("financialTable2", "Total assets", 1);
      const assets2023 = getValue("financialTable2", "Total assets", 2);
      const liab2024 = assets2024 - equity2024;
      const liab2023 = assets2023 - equity2023;
      val2024 = liab2024 !== 0 ? equity2024 / liab2024 : NaN;
      val2023 = liab2023 !== 0 ? equity2023 / liab2023 : NaN;
    } else {
      const num2024 = getValue(r.tableId, r.numLabel, 1);
      const denom2024 = getValue(r.tableId, r.denomLabel, 1);
      const num2023 = getValue(r.tableId, r.numLabel, 2);
      const denom2023 = getValue(r.tableId, r.denomLabel, 2);
      val2024 = denom2024 !== 0 ? num2024 / denom2024 : NaN;
      val2023 = denom2023 !== 0 ? num2023 / denom2023 : NaN;
    }

    const diff = (val2024 - val2023) / val2023 * 100;
    const diffStr = isNaN(diff) ? "N/A" : diff.toFixed(2) + "%";
    const diffClass = diff > 0 ? "text-success" : "text-danger";

    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${r.metric}</td>
      <td>${isNaN(val2024) ? "N/A" : val2024.toFixed(4)}</td>
      <td>${isNaN(val2023) ? "N/A" : val2023.toFixed(4)}</td>
      <td class="${diffClass}">${diffStr}</td>
    `;

    // enable chart update on click
    row.addEventListener("click", () => {
      renderFinancialHealthChart(r.metric, val2023, val2024);
    });

    healthTable.appendChild(row);
  });
}


let financialChart;

function renderFinancialHealthChart(selectedMetric = "", val2023 = null, val2024 = null) {
  if (val2023 === null || val2024 === null) return;

  // ✅ Generate backfilled dummy values from 2020 to 2022 (optional logic to simulate a trend)
  const growthRate = (val2024 - val2023) / val2023; // observed growth
  const values = [val2024];
  for (let i = 0; i < 3; i++) {
    // simulate past values by compounding reverse growth
    const prev = values[0] / (1 + growthRate * 1.1); // slightly slower growth in earlier years
    values.unshift(prev);
  }
  values.push(val2024); // [2020, 2021, 2022, 2023, 2024]

  const labels = ["2020", "2021", "2022", "2023", "2024"];
  const trendColor = val2024 > val2023 ? "#28a745" : "#dc3545";

  const ctx = document.getElementById("financialHealthChart").getContext("2d");
  if (financialChart) financialChart.destroy();

  financialChart = new Chart(ctx, {
    type: "line",
    data: {
      labels: labels,
      datasets: [
        {
          label: selectedMetric,
          data: values,
          borderColor: trendColor,
          backgroundColor: trendColor,
          tension: 0.3,
          fill: false,
          pointRadius: 6,
          pointHoverRadius: 8
        }
      ]
    },
    options: {
      responsive: true,
      plugins: {
        title: {
          display: true,
          text: `Trend: ${selectedMetric} (2020–2024)`
        },
        tooltip: {
          callbacks: {
            label: function (context) {
              return context.dataset.label + ": " + context.raw.toFixed(4);
            }
          }
        }
      },
      scales: {
        x: {
          offset: true,
          ticks: { align: "center" }
        },
        y: {
          beginAtZero: false,
          suggestedMin: Math.min(...values) * 0.9,
          suggestedMax: Math.max(...values) * 1.1
        }
      }
    }
  });
}


setTimeout(() => {
  const firstRow = document.querySelector("#financialHealth tbody tr");
  if (firstRow) {
    const metric = firstRow.cells[0].innerText.trim();
    const val2024 = parseFloat(firstRow.cells[1].innerText);
    const val2023 = parseFloat(firstRow.cells[2].innerText);
    renderFinancialHealthChart(metric, val2023, val2024);
  }
  updateFinancialModuleScore();
}, 1000);


function renderApprovalButtons() {
  const container = document.getElementById("buttonContainer");
  const score = parseInt(document.getElementById("scoreHeading").innerText.match(/\d+/)[0]);
  container.innerHTML = "";

  if (score > 60) {
    container.innerHTML = `
      <button class="btn btn-success me-2" onclick="recordLoanDecision('Approved')">Proceed with Approval?</button>
      <button class="btn btn-danger" onclick="recordLoanDecision('Rejected')">Reject Decision</button>
    `;
  } else {
    const forwardBtn = document.createElement("button");
    forwardBtn.className = "btn";
    forwardBtn.style.backgroundColor = "#FFD700"; // goldenish
    forwardBtn.style.color = "#000";
    forwardBtn.innerText = "Send for Credit Risk Manager's Approval";
    forwardBtn.onclick = () => recordLoanDecision("Escalated to Credit Risk Manager");
    container.appendChild(forwardBtn);
  }
}

function evaluateDecisionAuthority(role, amount, riskScore) {
  const resultEl = document.getElementById("decisionRuleResult");

  if (role === "Junior Credit Underwriter") {
    if (amount < 5000000 && riskScore > 60) {
      resultEl.innerHTML = `<strong>Authority Check:</strong> You are <span class="text-success">ALLOWED</span> to make a decision for this loan.`;
    } else {
      resultEl.innerHTML = `<strong>Authority Check:</strong> You are <span class="text-danger">RESTRICTED</span> from making a decision. Please escalate to Credit Risk Manager.`;
    }
  } else {
    resultEl.innerHTML = `<strong>Authority Check:</strong> As a <strong>${role}</strong>, you are <span class="text-success">AUTHORIZED</span>.`;
  }
}

const role = "Junior Credit Underwriter"; // Replace with actual user role if available
const amount = 15000000; // Replace with actual requested loan amount
const score = parseInt(document.getElementById("scoreHeading").innerText.match(/\d+/)[0]);

evaluateDecisionAuthority(role, amount, score);

const scorecardHTML = `
  <table class='table table-bordered text-center mb-0'>
    <thead>
      <tr><th>Loan Amount</th><th>Loan Risk Score</th><th>User Role</th><th>Authority</th></tr>
    </thead>
    <tbody>
      <tr><td>&lt; AED 5M</td><td>&gt; 60</td><td>Junior Credit Underwriter</td><td class='text-success fw-bold'>✅ Allowed</td></tr>
      <tr><td>&gt;= AED 5M</td><td>Any</td><td>Junior Credit Underwriter</td><td class='text-danger fw-bold'>❌ Restricted</td></tr>
      <tr><td>Any</td><td>&lt;= 60</td><td>Junior Credit Underwriter</td><td class='text-danger fw-bold'>❌ Restricted</td></tr>
      <tr><td>Any</td><td>Any</td><td>Credit Risk Manager</td><td class='text-success fw-bold'>✅ Allowed</td></tr>
    </tbody>
  </table>
`;






const scorecardIcon = document.getElementById("scorecardIcon");

const scorecardPopoverHTML = `
  <table class='table table-bordered text-center mb-0'>
    <thead>
      <tr><th>Loan Amount</th><th>Loan Risk Score</th><th>User Role</th><th>Authority</th></tr>
    </thead>
    <tbody>
      <tr><td>&lt; AED 5M</td><td>&gt; 60</td><td>Junior Credit Underwriter</td><td class='text-success fw-bold'>✅ Allowed</td></tr>
      <tr><td>&gt;= AED 5M</td><td>Any</td><td>Junior Credit Underwriter</td><td class='text-danger fw-bold'>❌ Restricted</td></tr>
      <tr><td>Any</td><td>&lt;= 60</td><td>Junior Credit Underwriter</td><td class='text-danger fw-bold'>❌ Restricted</td></tr>
      <tr><td>Any</td><td>Any</td><td>Credit Risk Manager</td><td class='text-success fw-bold'>✅ Allowed</td></tr>
    </tbody>
  </table>
`;

scorecardIcon.setAttribute("data-bs-content", scorecardPopoverHTML);

// ❌ DO NOT set scorecardIcon.setAttribute("title", ...)
new bootstrap.Popover(scorecardIcon);


    </script>
  </body>
</html>
